<!DOCTYPE html>
<html lang="en">

<head>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="sunrise.svg">
  <meta charset="UTF-8">
  <title>Location chooser</title>
  <link rel="stylesheet" type="text/css" href="calendar.css">
  <style>
    body {
      text-align: center;
    }

    body,
    input,
    select,
    button {
      font-size: calc(min(3vw, 20px));
    }
    div {
      margin: 12px;
      line-height: 2;
    }

    div.fav {
      margin-left: 2em;
      line-height: 1;
    }
    
    @media only screen and (max-width: 500px) {

      body,
      input,
      select,
      button {
        font-size: 15px;
      }
    }
  </style>
  <script>
  
    function start() {
      document.getElementById('name').focus();
      params = new URLSearchParams(localStorage.getItem('favorite'));
      console.log(localStorage.getItem('favorite'));
      document.getElementById('favPlace').innerHTML = params.get('name');
      document.getElementById('favLat').innerHTML = params.get('lat');
      document.getElementById('favLon').innerHTML = params.get('lon');
      document.getElementById('favAdjRise').innerHTML = params.get('sunriseAngle');
      document.getElementById('favAdjSet').innerHTML = params.get('sunsetAngle');
    }
    function save() {
      const choice = document.getElementById("choice");
      const sunriseAngle = document.getElementById("sunriseAngle");
      const sunsetAngle = document.getElementById("sunsetAngle");
      
      localStorage.setItem('favorite', `${choice.value}&sunriseAngle=${sunriseAngle.value}&sunsetAngle=${sunsetAngle.value}`);
      
      start();
    }
    async function search() {
      const place = document.getElementById("name");
      const choice = document.getElementById("choice");

      const url = `https://geocode.maps.co/search?q=${place.value}&api_key=6591c355a457b800916849qixd2539f`

      await fetch(url)
        .then(response => response.json())
        .then(result => buildSelect(result))
        .catch(error => alert("Error looking up places.  Try again."));
    }

    async function buildSelect(result) {
      const place = document.getElementById("name");
      const choice = document.getElementById("choice");
      choice.innerHTML = "";

      for (item of result) {
//        const tz = tzlookup(item.lat, item.lon);
        var option = document.createElement("option");
        option.value = `lat=${item.lat}&lon=${item.lon}&name=${item.display_name}`;
        option.text = item.display_name.length > 60?item.display_name.slice(0, 60) + "...":item.display_name;
        choice.appendChild(option);
      }
      var option = document.createElement("option"); 
      option.value = "mode=current";
      option.text = " -- Use current location -- ";
      choice.appendChild(option);    
    }

    function go() {
      const choice = document.getElementById("choice");
      const sunriseAngle = document.getElementById("sunriseAngle");
      const sunsetAngle = document.getElementById("sunsetAngle");
      
      location.href = `index.html?${choice.value}&sunriseAngle=${sunriseAngle.value}&sunsetAngle=${sunsetAngle.value}`;
    }
  </script>
</head>

<body onload="start()">
  <h2>Search for place name:</h2>
  <div><input name="name" id="name" onkeydown="if(event.keyCode==13) search()" onClick="this.select();" placeholder="Enter a place name"></div>
  
  <div><button onclick="search()">SEARCH</button></div>
  <div><select id="choice">
  <option value=""> -- Use current location -- </option>
  </select></div>
  <div>
  Angle adjust for sunrise: <input id="sunriseAngle"><br>
  Angle adjust for sunset: <input id="sunsetAngle">
  </div>
  <div>
    <button onclick="go()">View Selected Calendar</button>
    <button onclick="save()">Save as Favorite</button>
    <button onclick="window.history.back()">Cancel</button>
  </div>
  <div>Current Favorite:
    <div class="fav">Name: <span id="favPlace"></span></div>
    <div class="fav">Latitude: <span id="favLat"></span></div>
    <div class="fav">Longitude: <span id="favLon"></span></div>
    <div class="fav">Sunrise Angle: <span id="favAdjRise"></span></div>
    <div class="fav">Sunset Angle: <span id="favAdjSet"></span></div>
</body>

</html>